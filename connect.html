<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Your Pages ‚Äî Artemis AI</title>
    <meta name="description" content="Connect your Facebook pages to Artemis AI and unlock AI-powered social media intelligence.">
    <meta name="theme-color" content="#0a0e17">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèõÔ∏è</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg-primary:#060a13;--bg-secondary:#0c1221;--bg-tertiary:#111a2e;--bg-card:#0f1729;--bg-card-hover:#142036;--accent:#00d4aa;--accent-bright:#00f5c4;--accent-secondary:#6366f1;--accent-dim:rgba(0,212,170,0.1);--accent-glow:rgba(0,212,170,0.35);--accent-glow-strong:rgba(0,212,170,0.6);--text-primary:#e8ecf4;--text-secondary:#7b8ba8;--text-muted:#4a5568;--border:rgba(255,255,255,0.05);--border-accent:rgba(0,212,170,0.15);--border-accent-strong:rgba(0,212,170,0.3);--fb-blue:#1877f2;--fb-blue-hover:#166fe5;--danger:#f87171;--danger-dim:rgba(248,113,113,0.1);--success:#00d4aa;--warning:#febc2e}
        *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
        body{font-family:'Outfit',sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;-webkit-font-smoothing:antialiased;min-height:100vh}
        body::after{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");pointer-events:none;z-index:10000}
        ::selection{background:var(--accent);color:var(--bg-primary)}

        nav{position:fixed;top:0;left:0;right:0;z-index:1000;padding:0 3rem;height:72px;display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(24px) saturate(180%);background:rgba(6,10,19,0.85);border-bottom:1px solid var(--border)}
        .nav-logo{font-size:1.3rem;font-weight:700;letter-spacing:.12em;color:var(--text-primary);text-decoration:none;display:flex;align-items:center;gap:.7rem}
        .logo-mark{width:36px;height:36px;position:relative}.logo-mark svg{width:100%;height:100%}
        .nav-links{display:flex;align-items:center;gap:2rem;list-style:none}
        .nav-links a{color:var(--text-secondary);text-decoration:none;font-size:.88rem;font-weight:400;letter-spacing:.02em;transition:color .3s;position:relative}
        .nav-links a::after{content:'';position:absolute;bottom:-4px;left:0;right:0;height:1px;background:var(--accent);transform:scaleX(0);transition:transform .3s}
        .nav-links a:hover{color:var(--text-primary)}.nav-links a:hover::after{transform:scaleX(1)}
        .nav-cta{padding:.55rem 1.4rem!important;background:var(--accent)!important;color:var(--bg-primary)!important;border-radius:8px;font-weight:600!important;font-size:.82rem!important;transition:all .3s!important}
        .nav-cta::after{display:none!important}.nav-cta:hover{background:var(--accent-bright)!important;transform:translateY(-1px);box-shadow:0 8px 25px var(--accent-glow)}
        .hamburger{display:none;background:none;border:none;cursor:pointer;padding:4px}
        .hamburger span{display:block;width:22px;height:2px;background:var(--text-primary);margin:5px 0;border-radius:2px;transition:all .3s}

        .page-container{max-width:680px;margin:0 auto;padding:120px 2rem 4rem}

        .page-hero{text-align:center;margin-bottom:3rem;position:relative}
        .page-hero::before{content:'';position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:500px;height:300px;background:radial-gradient(ellipse,rgba(0,212,170,0.06),transparent 70%);pointer-events:none}
        .page-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem 1rem .4rem .7rem;background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.12);border-radius:100px;font-size:.75rem;font-weight:500;color:var(--accent);margin-bottom:1.5rem;letter-spacing:.04em}
        .page-badge svg{width:14px;height:14px;stroke:var(--accent);fill:none;stroke-width:2}
        .page-hero h1{font-size:clamp(1.8rem,4vw,2.6rem);font-weight:800;letter-spacing:-.03em;margin-bottom:.8rem;line-height:1.15}
        .page-hero h1 .gradient-text{background:linear-gradient(135deg,var(--accent) 0%,var(--accent-bright) 40%,#4fd1c5 70%,var(--accent-secondary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .page-hero p{font-size:1rem;color:var(--text-secondary);line-height:1.7;max-width:500px;margin:0 auto;font-weight:300}

        .connect-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;overflow:hidden;position:relative}
        .connect-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5}

        .tab-nav{display:flex;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.01)}
        .tab-btn{flex:1;padding:1rem;background:none;border:none;color:var(--accent);font-family:'Outfit',sans-serif;font-size:.88rem;font-weight:500;cursor:default;position:relative;letter-spacing:.01em}
        .tab-btn::after{content:'';position:absolute;bottom:-1px;left:20%;right:20%;height:2px;background:var(--accent);border-radius:2px 2px 0 0}
        .tab-btn svg{width:16px;height:16px;vertical-align:-3px;margin-right:.4rem}

        .tab-content{padding:2rem}

        .manual-section h2{font-size:1.2rem;font-weight:600;margin-bottom:.4rem}
        .manual-section>p{font-size:.85rem;color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem;font-weight:300}

        .form-group{margin-bottom:1.2rem}
        .form-label{display:block;font-size:.8rem;font-weight:500;color:var(--text-secondary);margin-bottom:.45rem;letter-spacing:.02em}
        .form-label .required{color:var(--danger);margin-left:.15rem}
        .form-input{width:100%;padding:.85rem 1.1rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:.82rem;outline:none;transition:all .3s;line-height:1.5}
        .form-input::placeholder{color:var(--text-muted);font-family:'Outfit',sans-serif}
        .form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,212,170,0.08)}
        textarea.form-input{min-height:100px;resize:vertical;font-family:'JetBrains Mono',monospace}
        .form-hint{font-size:.72rem;color:var(--text-muted);margin-top:.35rem;line-height:1.5}
        .form-hint a{color:var(--accent);text-decoration:none}
        .form-hint a:hover{text-decoration:underline}

        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

        .btn-submit{width:100%;padding:.9rem;background:var(--accent);color:var(--bg-primary);border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .35s;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.5rem}
        .btn-submit::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(255,255,255,0.15),transparent);transform:translateX(-100%);transition:transform .5s}
        .btn-submit:hover::before{transform:translateX(100%)}
        .btn-submit:hover{background:var(--accent-bright);transform:translateY(-1px);box-shadow:0 8px 30px var(--accent-glow)}
        .btn-submit:disabled{opacity:.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}
        .btn-submit svg{width:18px;height:18px;stroke:var(--bg-primary);fill:none;stroke-width:2}

        .status-banner{padding:.85rem 1.1rem;border-radius:10px;font-size:.85rem;display:none;align-items:flex-start;gap:.6rem;margin-bottom:1.2rem;animation:fadeIn .3s ease}
        .status-banner.show{display:flex}
        .status-banner.success{background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.15);color:var(--accent)}
        .status-banner.error{background:var(--danger-dim);border:1px solid rgba(248,113,113,0.2);color:var(--danger)}
        .status-banner.warning{background:rgba(254,188,46,0.06);border:1px solid rgba(254,188,46,0.15);color:var(--warning)}
        .status-banner.info{background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.15);color:var(--accent-secondary)}
        .status-icon{flex-shrink:0;margin-top:1px}
        .status-text{line-height:1.55;font-weight:400}
        .status-text strong{font-weight:600}

        @keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}

        .pages-result{margin-top:1.5rem;display:none}
        .pages-result.show{display:block}
        .pages-result h3{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--text-muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:.8rem}
        .page-row{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:10px;margin-bottom:.5rem;transition:all .3s}
        .page-row:hover{border-color:var(--border-accent)}
        .page-row.has-warning{border-color:rgba(254,188,46,0.3)}
        .page-row.has-error{border-color:rgba(248,113,113,0.3)}
        .page-row-icon{width:36px;height:36px;background:rgba(24,119,242,0.08);border:1px solid rgba(24,119,242,0.12);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .page-row-icon svg{width:16px;height:16px;fill:var(--fb-blue)}
        .page-row-info{flex:1;min-width:0}
        .page-row-name{font-size:.88rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .page-row-meta{font-size:.72rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
        .page-row-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .page-row-status.ok{background:var(--accent);box-shadow:0 0 8px var(--accent-glow)}
        .page-row-status.warn{background:var(--warning);box-shadow:0 0 8px rgba(254,188,46,0.4)}
        .page-row-status.fail{background:var(--danger);box-shadow:0 0 8px rgba(248,113,113,0.4)}
        .page-row-status.checking{background:var(--text-muted);animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

        .perm-badges{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
        .perm-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:4px;font-size:.62rem;font-family:'JetBrains Mono',monospace;font-weight:500;letter-spacing:.02em}
        .perm-badge.granted{background:rgba(0,212,170,0.08);border:1px solid rgba(0,212,170,0.2);color:var(--accent)}
        .perm-badge.missing{background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);color:var(--danger)}
        .perm-badge.unknown{background:rgba(255,255,255,0.03);border:1px solid var(--border);color:var(--text-muted)}
        .perm-badge svg{width:9px;height:9px;stroke-width:2.5;fill:none}
        .perm-badge.granted svg{stroke:var(--accent)}
        .perm-badge.missing svg{stroke:var(--danger)}

        .perm-summary{margin-top:1rem;padding:1rem;border-radius:10px;font-size:.82rem;line-height:1.6}
        .perm-summary.all-good{background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.15);color:var(--accent)}
        .perm-summary.has-issues{background:rgba(254,188,46,0.06);border:1px solid rgba(254,188,46,0.15);color:var(--warning)}
        .perm-summary strong{font-weight:600}

        .info-section{margin-top:2.5rem}
        .info-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:1.5rem;margin-bottom:1rem}
        .info-card h3{font-size:.9rem;font-weight:600;margin-bottom:.6rem;display:flex;align-items:center;gap:.5rem}
        .info-card h3 svg{width:16px;height:16px;stroke:var(--accent);fill:none;stroke-width:2}
        .info-card p,.info-card li{font-size:.82rem;color:var(--text-secondary);line-height:1.65;font-weight:300}
        .info-card ol{padding-left:1.2rem;margin-top:.5rem}
        .info-card ol li{margin-bottom:.4rem}
        .info-card code{font-family:'JetBrains Mono',monospace;font-size:.75rem;background:var(--bg-primary);border:1px solid var(--border);padding:.15rem .45rem;border-radius:4px;color:var(--accent)}

        .spinner{width:18px;height:18px;border:2px solid rgba(6,10,19,0.2);border-top-color:var(--bg-primary);border-radius:50%;animation:spin .6s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        footer{padding:2.5rem 2rem;border-top:1px solid var(--border);text-align:center;background:var(--bg-primary)}
        .footer-content{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto}
        footer p{font-size:.78rem;color:var(--text-muted)}
        footer a{color:var(--accent);text-decoration:none;transition:color .3s}footer a:hover{color:var(--accent-bright)}
        .footer-links{display:flex;gap:1.5rem}.footer-links a{font-size:.78rem;color:var(--text-muted)}.footer-links a:hover{color:var(--accent)}

        @media(max-width:768px){
            nav{padding:0 1.5rem}
            .nav-links{display:none;position:absolute;top:100%;left:0;right:0;flex-direction:column;background:rgba(6,10,19,0.98);backdrop-filter:blur(20px);padding:1.5rem;gap:.75rem;border-bottom:1px solid var(--border)}
            .nav-links.open{display:flex}
            .hamburger{display:block}
            .page-container{padding:100px 1.25rem 3rem}
            .tab-content{padding:1.5rem}
            .form-row{grid-template-columns:1fr}
            .footer-content{flex-direction:column;gap:1rem}
        }
    </style>
</head>
<body>

    <nav>
        <a href="/" class="nav-logo">
            <div class="logo-mark"><svg viewBox="0 0 36 36" fill="none"><rect x="2" y="2" width="32" height="32" rx="8" stroke="url(#lg)" stroke-width="2"/><path d="M18 8L26 28H10L18 8Z" stroke="url(#lg)" stroke-width="1.5" fill="none"/><circle cx="18" cy="20" r="3" fill="url(#lg)"/><defs><linearGradient id="lg" x1="4" y1="4" x2="32" y2="32"><stop stop-color="#00d4aa"/><stop offset="1" stop-color="#00a88a"/></linearGradient></defs></svg></div>
            ARTEMIS
        </a>
        <button class="hamburger" onclick="document.querySelector('.nav-links').classList.toggle('open')" aria-label="Menu"><span></span><span></span><span></span></button>
        <ul class="nav-links">
            <li><a href="/#features">Features</a></li>
            <li><a href="/#how">How It Works</a></li>
            <li><a href="/#team">Team</a></li>
            <li><a href="/#contact">Contact</a></li>
            <li><a href="/#contact" class="nav-cta">Get Early Access</a></li>
        </ul>
    </nav>

    <div class="page-container">

        <div class="page-hero">
            <div class="page-badge">
                <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Secure Connection
            </div>
            <h1>Connect Your <span class="gradient-text">Facebook Pages</span></h1>
            <p>Link your pages to Artemis so we can start analysing your content, audience, and engagement patterns.</p>
        </div>

        <div class="connect-card">
            <div class="tab-nav">
                <button class="tab-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                    Connect with Token
                </button>
            </div>

            <div class="tab-content" style="display:block">
                <div class="manual-section">
                    <h2>Submit Your Access Token</h2>
                    <p>Paste your Facebook User Access Token below. We'll validate it, fetch your pages, and verify each page has the permissions Artemis needs.</p>

                    <div id="manualStatus" class="status-banner"></div>

                    <form id="tokenForm" onsubmit="submitToken(event)">
                        <div class="form-group">
                            <label class="form-label">Access Token <span class="required">*</span></label>
                            <textarea class="form-input" id="tokenInput" placeholder="Paste your Facebook access token here..." required></textarea>
                            <div class="form-hint">
                                Get a token from the <a href="https://developers.facebook.com/tools/explorer/" target="_blank" rel="noopener">Graph API Explorer</a>. Must include <code>pages_read_engagement</code> and <code>read_insights</code>.
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Your Name</label>
                                <input type="text" class="form-input" id="userName" placeholder="e.g. John Doe" style="font-family:'Outfit',sans-serif">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="userEmail" placeholder="you@company.com" style="font-family:'Outfit',sans-serif">
                            </div>
                        </div>

                        <button type="submit" class="btn-submit" id="btnSubmit">
                            <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22l-4-9-9-4z"/></svg>
                            Validate & Connect Pages
                        </button>
                    </form>

                    <div class="pages-result" id="pagesResult">
                        <h3>Connected Pages</h3>
                        <div id="pagesList"></div>
                        <div id="permSummary"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-card">
                <h3>
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    How to get a token
                </h3>
                <ol>
                    <li>Go to <a href="https://developers.facebook.com/tools/explorer/" target="_blank" rel="noopener" style="color:var(--accent)">Graph API Explorer</a></li>
                    <li>Select your app from the dropdown</li>
                    <li>Click <strong>"Generate Access Token"</strong></li>
                    <li>Grant the permissions: <code>pages_show_list</code>, <code>pages_read_engagement</code>, <code>read_insights</code></li>
                    <li>Copy the token and paste it above</li>
                </ol>
            </div>

            <div class="info-card">
                <h3>
                    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Your data is safe
                </h3>
                <p>Artemis only reads your page data ‚Äî we never post, edit, or delete anything on your pages. Tokens are encrypted at rest and transmitted over HTTPS. You can revoke access at any time from your Facebook settings.</p>
            </div>
        </div>

    </div>

    <footer>
        <div class="footer-content">
            <p>&copy; 2026 Artemis AI ‚Äî The Complete Social Media Intelligence Platform</p>
            <div class="footer-links">
                <a href="/">Home</a>
                <a href="#">Privacy</a>
                <a href="#">Terms</a>
            </div>
        </div>
    </footer>

    <script>
    const CONFIG = {
        API_VERSION: 'v22.0',
        BACKEND_URL: '/api/connect',
        REQUIRED_PERMISSIONS: ['pages_read_engagement', 'read_insights'],
    };

    const ICONS = {
        check: '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>',
        cross: '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    };

    // =============================================
    // MAIN SUBMIT FLOW
    // =============================================
    async function submitToken(e) {
        e.preventDefault();
        const token = document.getElementById('tokenInput').value.trim();
        const name = document.getElementById('userName').value.trim();
        const email = document.getElementById('userEmail').value.trim();

        if (!token) { showStatus('manualStatus', 'error', 'Please paste your access token.'); return; }

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Validating token...';
        hideStatus('manualStatus');
        document.getElementById('pagesResult').classList.remove('show');

        try {
            // ‚îÄ‚îÄ Step 1: Validate token & check user-level scopes ‚îÄ‚îÄ
            showStatus('manualStatus', 'info', '<strong>Step 1/4:</strong> Validating token...');

            const debugRes = await fetch(`https://graph.facebook.com/${CONFIG.API_VERSION}/debug_token?input_token=${encodeURIComponent(token)}&access_token=${encodeURIComponent(token)}`);
            const debugData = await debugRes.json();

            if (debugData.error || !debugData.data) throw new Error(debugData.error?.message || 'Invalid token');

            const userScopes = debugData.data.scopes || [];
            const missingScopes = CONFIG.REQUIRED_PERMISSIONS.filter(p => !userScopes.includes(p));

            if (missingScopes.length > 0) {
                showStatus('manualStatus', 'warning', `<strong>Missing user-level permissions:</strong> ${missingScopes.map(s => '<code>' + s + '</code>').join(', ')}. Found: ${userScopes.join(', ')}. Please generate a new token with the correct permissions.`);
                resetBtn(); return;
            }

            // ‚îÄ‚îÄ Step 2: Fetch pages ‚îÄ‚îÄ
            btn.innerHTML = '<span class="spinner"></span> Fetching pages...';
            showStatus('manualStatus', 'info', '<strong>Step 2/4:</strong> Fetching your pages...');

            const pagesRes = await fetch(`https://graph.facebook.com/${CONFIG.API_VERSION}/me/accounts?fields=id,name,access_token,category,tasks&limit=100&access_token=${encodeURIComponent(token)}`);
            const pagesData = await pagesRes.json();
            if (pagesData.error) throw new Error(pagesData.error.message);

            const pages = pagesData.data || [];
            if (pages.length === 0) {
                showStatus('manualStatus', 'warning', '<strong>No pages found.</strong> Make sure you\'re using a User Access Token and that you manage at least one page.');
                resetBtn(); return;
            }

            // ‚îÄ‚îÄ Step 3: Show pages + check permissions per page ‚îÄ‚îÄ
            btn.innerHTML = '<span class="spinner"></span> Checking permissions...';
            showStatus('manualStatus', 'info', `<strong>Step 3/4:</strong> Checking permissions for ${pages.length} page(s)...`);

            displayPagesInitial(pages);
            const permResults = await checkAllPagePermissions(pages);
            showPermissionSummary(pages, permResults);

            // ‚îÄ‚îÄ Step 4: Send to backend ‚îÄ‚îÄ
            btn.innerHTML = '<span class="spinner"></span> Saving to Artemis...';
            showStatus('manualStatus', 'info', `<strong>Step 4/4:</strong> Saving ${pages.length} page(s)...`);

            await sendToBackend({
                type: 'manual_token',
                user_token: token,
                user_name: name,
                user_email: email,
                pages: pages.map(p => ({
                    id: p.id, name: p.name, access_token: p.access_token,
                    category: p.category, tasks: p.tasks,
                    permissions: permResults[p.id] || {},
                }))
            });

            // ‚îÄ‚îÄ Final status ‚îÄ‚îÄ
            const fullPerms = Object.values(permResults).filter(r => r.read_engagement && r.read_insights).length;
            if (fullPerms === pages.length) {
                showStatus('manualStatus', 'success', `<strong>All done!</strong> ${pages.length} page(s) connected with full permissions. Artemis will start analysing your data shortly.`);
            } else {
                showStatus('manualStatus', 'warning', `<strong>Connected ${pages.length} page(s)</strong> ‚Äî ${fullPerms} with full permissions, ${pages.length - fullPerms} with issues. Check the details below.`);
            }

        } catch (err) {
            showStatus('manualStatus', 'error', `<strong>Error:</strong> ${err.message}`);
        }
        resetBtn();
    }

    // =============================================
    // PER-PAGE PERMISSION CHECKING
    // =============================================
    async function checkAllPagePermissions(pages) {
        const results = {};
        for (const page of pages) {
            results[page.id] = await checkPagePerms(page);
            updatePageRow(page.id, results[page.id]);
        }
        return results;
    }

    async function checkPagePerms(page) {
        const r = { read_engagement: false, read_insights: false, feed: false };
        const pt = page.access_token;
        if (!pt) return r;

        // Check feed + engagement
        try {
            const res = await fetch(`https://graph.facebook.com/${CONFIG.API_VERSION}/${page.id}/feed?fields=id,likes.summary(true),comments.summary(true)&limit=1&access_token=${encodeURIComponent(pt)}`);
            const data = await res.json();
            if (!data.error) {
                r.feed = true;
                r.read_engagement = true;
            }
        } catch (e) { console.warn('Feed check failed:', page.name, e); }

        // Check insights
        try {
            const res = await fetch(`https://graph.facebook.com/${CONFIG.API_VERSION}/${page.id}/insights/page_impressions?period=day&limit=1&access_token=${encodeURIComponent(pt)}`);
            const data = await res.json();
            if (!data.error) {
                r.read_insights = true;
            }
        } catch (e) { console.warn('Insights check failed:', page.name, e); }

        return r;
    }

    // =============================================
    // DISPLAY
    // =============================================
    function displayPagesInitial(pages) {
        const list = document.getElementById('pagesList');
        list.innerHTML = pages.map(p => `
            <div class="page-row" id="pr-${p.id}">
                <div class="page-row-icon">
                    <svg viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" fill="#1877F2"/></svg>
                </div>
                <div class="page-row-info">
                    <div class="page-row-name">${esc(p.name)}</div>
                    <div class="page-row-meta">ID: ${p.id}${p.category ? ' ¬∑ ' + esc(p.category) : ''}</div>
                    <div class="perm-badges" id="pb-${p.id}">
                        <span class="perm-badge unknown">checking permissions...</span>
                    </div>
                </div>
                <div class="page-row-status checking" id="ps-${p.id}" title="Checking..."></div>
            </div>
        `).join('');
        document.getElementById('pagesResult').classList.add('show');
    }

    function updatePageRow(id, perms) {
        const badges = document.getElementById('pb-' + id);
        const dot = document.getElementById('ps-' + id);
        const row = document.getElementById('pr-' + id);
        if (!badges) return;

        const allOk = perms.read_engagement && perms.read_insights;
        const partial = perms.read_engagement || perms.read_insights;

        dot.className = 'page-row-status ' + (allOk ? 'ok' : partial ? 'warn' : 'fail');
        dot.title = allOk ? 'All permissions OK' : 'Missing permissions';
        if (!allOk) row.className = 'page-row ' + (partial ? 'has-warning' : 'has-error');

        badges.innerHTML = [
            { label: 'read_engagement', ok: perms.read_engagement },
            { label: 'read_insights', ok: perms.read_insights },
            { label: 'feed', ok: perms.feed },
        ].map(b => `<span class="perm-badge ${b.ok ? 'granted' : 'missing'}">${b.ok ? ICONS.check : ICONS.cross} ${b.label}</span>`).join('');
    }

    function showPermissionSummary(pages, permResults) {
        const total = pages.length;
        const ok = Object.values(permResults).filter(r => r.read_engagement && r.read_insights).length;
        const el = document.getElementById('permSummary');

        if (ok === total) {
            el.innerHTML = `<div class="perm-summary all-good"><strong>‚úì All ${total} page(s) have full permissions.</strong> Artemis can read engagement data and insights for every connected page.</div>`;
        } else {
            el.innerHTML = `<div class="perm-summary has-issues"><strong>‚ö† ${total - ok} of ${total} page(s) have missing permissions.</strong> Try regenerating your token with <code>pages_read_engagement</code> and <code>read_insights</code> granted for all pages.</div>`;
        }
    }

    // =============================================
    // BACKEND
    // =============================================
    async function sendToBackend(data) {
        try {
            const res = await fetch(CONFIG.BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) console.warn('Backend:', res.status);
            return await res.json().catch(() => ({}));
        } catch (err) {
            console.warn('Backend not reachable:', err.message);
            return {};
        }
    }

    // =============================================
    // HELPERS
    // =============================================
    function showStatus(id, type, html) {
        const el = document.getElementById(id);
        el.className = `status-banner show ${type}`;
        const icons = { success: '‚úì', error: '‚úó', warning: '‚ö†', info: '‚ü≥' };
        el.innerHTML = `<span class="status-icon">${icons[type] || ''}</span><span class="status-text">${html}</span>`;
    }
    function hideStatus(id) { document.getElementById(id).classList.remove('show'); }
    function resetBtn() {
        const btn = document.getElementById('btnSubmit');
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22l-4-9-9-4z"/></svg> Validate & Connect Pages';
    }
    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    </script>
</body>
</html>